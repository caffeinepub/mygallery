{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 3,
  "summary": "MyGallery is an installable PWA (React + TypeScript + Tailwind + shadcn/ui) backed by a Motoko canister on the Internet Computer. Users authenticate via Internet Identity (30-day delegation). After authentication, the frontend initializes an identity-bound canister actor and bootstraps role-based access control. Authenticated users can upload files with global progress tracking, browse a main collection or per-folder views, preview supported file types (images, videos, PDFs, and Office documents via Office Online embed), and manage files with move-to-folder, download, share (Web Share API), and delete (single/bulk) actions. The app also includes per-user Notes and Missions (task checklists) full-screen tools persisted in the canister, plus backend diagnostics and blob-storage maintenance/cycles refill endpoints.",
  "existing_features": [
    {
      "id": "IF-1",
      "title": "Installable PWA (manifest + service worker)",
      "synonyms": [
        "manifest.json",
        "sw.js",
        "standalone display"
      ],
      "description": "Provides PWA metadata/icons and a service worker with minimal precaching, immediate activation (skipWaiting), cache cleanup, and network-first runtime caching for app assets.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-2",
      "title": "Internet Identity authentication with persisted sessions",
      "synonyms": [
        "InternetIdentityProvider",
        "AuthClient",
        "DelegationIdentity",
        "maxTimeToLive"
      ],
      "description": "Supports Internet Identity login/logout and restores a previously authenticated identity on reload; requests ~30-day delegations and exposes login state flags for UI gating.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-3",
      "title": "Theme system with light/dark/system toggle",
      "synonyms": [
        "next-themes",
        "ThemeProvider",
        "Tailwind CSS variables"
      ],
      "description": "Implements app-wide theming with a header toggle and Tailwind colors driven by CSS variables (including dark mode tokens).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-4",
      "title": "Post-login intro splash screen (session-only)",
      "synonyms": [
        "IntroScreen",
        "AnimatedGalleryIcon"
      ],
      "description": "Shows a timed welcome animation after a successful login and transitions into the main app; intended to show once per session.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-5",
      "title": "Authenticated backend actor initialization with lifecycle state, retry, and sign-out",
      "synonyms": [
        "ActorProvider",
        "ActorContext",
        "idle/initializing/ready/error"
      ],
      "description": "Creates an identity-bound canister actor after authentication, runs access-control initialization, and exposes status/error plus retry and sign-out methods for UI gating.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-6",
      "title": "Secret parameter extraction from URL hash with session persistence and URL cleanup",
      "synonyms": [
        "getSecretParameter",
        "getSecretFromHash",
        "sessionStorage",
        "clearParamFromHash"
      ],
      "description": "Extracts sensitive parameters (e.g., caffeineAdminToken) from the URL hash, persists them to sessionStorage, and removes them from the URL to reduce leakage.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-7",
      "title": "Standardized actor initialization error classification and messaging",
      "synonyms": [
        "mapActorInitError",
        "IC0508 detection",
        "reject_code=5",
        "destination invalid"
      ],
      "description": "Detects actor-not-ready, initialization/auth errors, and stopped-canister errors; maps them to user-friendly summaries plus serialized technical details preserving structured reject fields.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-8",
      "title": "Actor initialization error screen with technical details, retry, and sign-out",
      "synonyms": [
        "ActorInitErrorState",
        "Collapsible technical details"
      ],
      "description": "Renders a connection failure UI with retry/sign-out actions and an expandable technical-details panel for debugging, including specialized “service unavailable” styling.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-9",
      "title": "React Query data layer gated by authentication and actor readiness",
      "synonyms": [
        "@tanstack/react-query",
        "enabled gating",
        "invalidateQueries",
        "optimistic updates"
      ],
      "description": "Provides query/mutation hooks for backend operations that only run when identity exists and actor status is ready; includes invalidation and optimistic updates for selected flows.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-10",
      "title": "Chunked concurrent multi-file upload with per-file progress callbacks",
      "synonyms": [
        "useUploadFiles",
        "ExternalBlob.fromBytes",
        "withUploadProgress"
      ],
      "description": "Uploads multiple files in small concurrent chunks using ExternalBlob and emits per-file progress updates for UI tracking; refreshes file list on success.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-11",
      "title": "Global upload batch tracking and unified progress bar",
      "synonyms": [
        "UploadContext",
        "UnifiedProgressBar",
        "aggregate progress"
      ],
      "description": "Tracks upload batches and per-file progress globally; computes aggregate progress and displays a unified progress bar under the header while uploads are active.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-12",
      "title": "Upload UI with backend readiness gating and toast feedback",
      "synonyms": [
        "FileUploadSection",
        "sonner toasts"
      ],
      "description": "Provides a multi-file upload control; blocks uploads until the actor is ready; reports progress via UploadContext and shows success/failure toasts.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-13",
      "title": "Folder listing and CRUD with optimistic updates",
      "synonyms": [
        "useGetFolders",
        "useCreateFolder",
        "useRenameFolder",
        "useDeleteFolder"
      ],
      "description": "Implements folder creation, rename (optimistic update + rollback), deletion (optimistic removal + rollback), and listing with cache invalidation.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-14",
      "title": "Folder management UI (list/select/create/rename/delete)",
      "synonyms": [
        "FoldersDialog",
        "FoldersButton"
      ],
      "description": "Provides a dialog to list/select folders and perform folder CRUD actions with actor readiness checks and toast feedback; includes a floating folders button entry point.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-15",
      "title": "File listing for main collection and folder-scoped views",
      "synonyms": [
        "useGetFilesNotInFolder",
        "useGetFilesInFolder",
        "getPaginatedFiles",
        "getFilesInFolder"
      ],
      "description": "Lists caller-owned files either in the main collection (unfoldered) or within a selected folder via backend queries (offset/limit window).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-16",
      "title": "Move files into folders and remove from folders",
      "synonyms": [
        "useMoveFilesToFolder",
        "useRemoveFromFolder",
        "SendToFolderDialog"
      ],
      "description": "Moves one or many files into a target folder and supports returning files to the main collection by removing folder assignment; includes optimistic cache updates for move.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-17",
      "title": "Single and bulk file deletion with chunking and optimistic cache updates",
      "synonyms": [
        "useDeleteFile",
        "useDeleteFiles",
        "chunked delete",
        "optimistic removal"
      ],
      "description": "Deletes single files and performs chunked bulk deletion; updates cached file lists optimistically with rollback on error and invalidation on success.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-18",
      "title": "Gallery browsing UI with loading, empty, and error states",
      "synonyms": [
        "GallerySection",
        "Skeleton loading",
        "folder view",
        "collection view"
      ],
      "description": "Displays a responsive grid of file cards for either the unfoldered collection or a selected folder, with skeleton loading, empty state, and error state UI.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-19",
      "title": "Touch-first long-press multi-select mode with bulk actions toolbar",
      "synonyms": [
        "long press selection",
        "bulk toolbar",
        "navigator.vibrate"
      ],
      "description": "Enables multi-selection via touch long-press and provides a bottom action bar to move, share, download, or delete selected files.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-20",
      "title": "Web Share API integration (single and multi-file)",
      "synonyms": [
        "navigator.share",
        "share files"
      ],
      "description": "Shares files via the Web Share API by fetching direct URLs, constructing File objects, and invoking navigator.share when supported.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-21",
      "title": "MIME-aware file categorization and open rules",
      "synonyms": [
        "getFileCategory",
        "fileOpenRules",
        "shouldOpenInViewer",
        "shouldDownloadDirectly"
      ],
      "description": "Categorizes files by MIME type and determines whether to open in-app (viewer/Office preview) or download directly for unsupported types.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-22",
      "title": "Full-screen in-app file viewer with swipe/keyboard navigation and actions",
      "synonyms": [
        "FullScreenViewer",
        "swipe navigation",
        "keyboard navigation",
        "Office Online embed"
      ],
      "description": "Provides a full-screen dialog viewer for images, videos, PDFs, and Office documents (Office Online embed), including next/prev navigation and actions (move/share/download/delete) and a new-tab option for Office docs.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-23",
      "title": "Popup-blocker-aware external open fallback dialog",
      "synonyms": [
        "ExternalOpenFallbackDialog",
        "openExternally",
        "download fallback"
      ],
      "description": "When opening a file in a new tab/window is blocked, shows a dialog offering retry or a reliable fetch+blob download fallback.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-24",
      "title": "File preview dialog with metadata and management actions",
      "synonyms": [
        "FilePreviewDialog",
        "preview modal",
        "metadata display"
      ],
      "description": "Implements a preview dialog for images/videos/PDF/Office (iframe/embed), shows metadata (MIME type, timestamp, size), and supports open/download/move/delete with confirmation.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-25",
      "title": "Notes entry point and full-screen Notes experience (multi-note CRUD)",
      "synonyms": [
        "NotesButton",
        "NotesFullScreenView",
        "useNotesQueries"
      ],
      "description": "Implements per-user Notes as a full-screen experience with list and editor (mobile-friendly behavior), supporting create/select/update/delete with canister persistence and toasts.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-26",
      "title": "Notes timestamp formatting utility",
      "synonyms": [
        "formatNotesTime",
        "relative time"
      ],
      "description": "Formats timestamps into user-friendly English relative strings with a short-date fallback for older entries.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-27",
      "title": "Missions entry point and full-screen Missions list view with progress indicators",
      "synonyms": [
        "MissionsButton",
        "MissionsFullScreenView",
        "Progress"
      ],
      "description": "Displays a list of missions with progress bars and completion styling; supports creating new missions and deleting missions with confirmation; selecting a mission navigates to mission detail full-screen.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-28",
      "title": "Mission creation dialog with checklist tasks",
      "synonyms": [
        "MissionEditorDialog",
        "Task checklist"
      ],
      "description": "Creates missions in a modal dialog; manages task list (add/toggle/remove), and submits creation via backend mutation with readiness gating and toasts.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-29",
      "title": "Mission detail full-screen view with checklist editing and inline add-task",
      "synonyms": [
        "MissionDetailFullScreenView",
        "full-screen mission editor"
      ],
      "description": "Allows viewing/editing an existing mission in a dedicated full-screen view: editable title, checklist with completion toggles (completed tasks remain visible and styled), inline add-task input, save changes, and delete mission with confirmation.",
      "reqIds": [
        "REQ-13",
        "REQ-14",
        "REQ-15",
        "REQ-16"
      ],
      "version": 1
    },
    {
      "id": "IF-30",
      "title": "Role-based access control bootstrap and role management (backend)",
      "synonyms": [
        "AccessControl",
        "MixinAuthorization",
        "CAFFEINE_ADMIN_TOKEN",
        "_initializeAccessControlWithSecret"
      ],
      "description": "Bootstraps roles using a canister-side admin token and a user-provided secret (first matching caller can become admin; others become users). Exposes role/admin checks and admin-only role assignment.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-31",
      "title": "Backend file storage with ownership enforcement and pagination",
      "synonyms": [
        "uploadFile",
        "getPaginatedFiles",
        "getFilesInFolder",
        "getFile",
        "deleteFile",
        "deleteFiles"
      ],
      "description": "Stores file blobs and metadata in the canister, lists caller-owned files (unfoldered or by folder) with pagination/sorting, retrieves file metadata, and deletes files (single/bulk) with ownership/admin checks.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-32",
      "title": "Backend folder storage and file organization (per-user)",
      "synonyms": [
        "createFolder",
        "renameFolder",
        "deleteFolder",
        "getAllFolders",
        "moveFilesToFolder",
        "removeFromFolder"
      ],
      "description": "Implements per-user folders with CRUD and listing, viewing files by folder, moving files into folders, and removing files back to the main collection with access checks.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-33",
      "title": "Backend per-user Notes storage (CRUD + listing)",
      "synonyms": [
        "createNote",
        "getNote",
        "updateNote",
        "deleteNote",
        "listNotes"
      ],
      "description": "Stores notes per principal with access control enforcement so only authenticated users can access and mutate their own notes.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-34",
      "title": "Backend per-user Missions storage (CRUD + listing)",
      "synonyms": [
        "createMission",
        "getMission",
        "updateMission",
        "deleteMission",
        "listMissions"
      ],
      "description": "Stores missions per principal with access control enforcement so only authenticated users can access and mutate their own missions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-35",
      "title": "Backend user profile endpoints",
      "synonyms": [
        "getCallerUserProfile",
        "getUserProfile",
        "saveCallerUserProfile"
      ],
      "description": "Stores and retrieves a simple per-user profile (name) with access controls (non-admins can only view their own profile).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-36",
      "title": "Backend diagnostics endpoint (build + cycles)",
      "synonyms": [
        "getDiagnostics",
        "cycles balance"
      ],
      "description": "Exposes a query endpoint returning a build/version string and the current canister cycles balance for operational diagnostics.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-37",
      "title": "Blob-storage maintenance, authorization, and cycles refill endpoints (backend)",
      "synonyms": [
        "_caffeineStorageUpdateGatewayPrincipals",
        "_caffeineStorageBlobsToDelete",
        "_caffeineStorageConfirmBlobDeletion",
        "_caffeineStorageBlobIsLive",
        "_caffeineStorageRefillCashier"
      ],
      "description": "Provides maintenance endpoints to refresh authorized gateway principals, list/confirm dead blob deletions (authorized callers only) with forced GC, check blob liveness, and allow a cashier canister to top up cycles.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-38",
      "title": "Admin-only backend listing of all files",
      "synonyms": [
        "getAllFiles",
        "admin query"
      ],
      "description": "Provides an admin-gated query to list all stored files regardless of owner.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "feature-identify-the-root-cause-of-the-frequent-service-unavailable-backend-service-is-currently-unavailable-error-shown-when-opening-the-draft-or-live-app-after-each-deploy-prompt-and-implement-a-fix-so-the-app-opens-normally-and-remains-functional",
      "title": "Identify the root cause of the frequent 'Service Unavailable / backend service is currently unavailable' error shown when opening the Draft or Live app after each deploy/prompt, and implement a fix so the app opens normally and remains functional.",
      "reqIds": [
        "REQ-17"
      ],
      "version": 1
    },
    {
      "id": "feature-change-the-actor-initialization-flow-so-that-on-the-first-app-open-only-cold-start-initialization-failures-consistent-with-canister-warm-up-unavailability-are-handled-via-silent-background-retry-with-backoff-keeping-the-ui-in-a-loading-state-instead-of-rendering-actoriniterrorstate",
      "title": "Change the actor initialization flow so that on the first app open only (cold start), initialization failures consistent with canister warm-up/unavailability are handled via silent background retry with backoff, keeping the UI in a loading state instead of rendering ActorInitErrorState.",
      "reqIds": [
        "REQ-18"
      ],
      "version": 1
    },
    {
      "id": "feature-ensure-the-silent-retry-behavior-is-applied-only-on-the-first-open-in-a-session-and-after-the-app-has-successfully-initialized-once-subsequent-actor-initialization-failures-show-the-existing-error-ui-actoriniterrorstate-immediately-or-after-the-normal-non-cold-start-retry-behavior",
      "title": "Ensure the silent-retry behavior is applied only on the first open in a session, and after the app has successfully initialized once, subsequent actor initialization failures show the existing error UI (ActorInitErrorState) immediately (or after the normal non-cold-start retry behavior).",
      "reqIds": [
        "REQ-19"
      ],
      "version": 1
    },
    {
      "id": "feature-unify-error-classification-for-canister-stopped-detection-so-that-actoriniterrorstate-uses-the-standardized-detection-logic-rather-than-summary-string-heuristics-and-ensure-the-cold-start-silent-retry-triggers-off-the-same-standardized-classification",
      "title": "Unify error classification for canister-stopped detection so that ActorInitErrorState uses the standardized detection logic (rather than summary-string heuristics), and ensure the cold-start silent retry triggers off the same standardized classification.",
      "reqIds": [
        "REQ-20"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [
    {
      "id": "AR-1",
      "summary": "On cold start (first open after deploy/prompt), suppress 'Service Unavailable/Connection Failed' screens and perform silent background retry for auth/actor initialization until backend is ready; only show error UI on persistent failure.",
      "reqIds": [],
      "status": "pending"
    }
  ],
  "architectural_notes": [
    "Frontend is a React SPA using function components, TypeScript, TailwindCSS (CSS-variable tokens using OKLCH), and shadcn/ui primitives (Dialog, AlertDialog, ScrollArea, Progress, Checkbox, Collapsible, DropdownMenu).",
    "Authentication is implemented with Internet Identity via @dfinity/auth-client; a provider restores identity on reload and exposes granular login states (initializing/idle/logging-in/success/error).",
    "Backend access is via an identity-bound canister actor created with createActorWithConfig; ActorContext tracks actor lifecycle (idle → initializing → ready/error) and gates UI and React Query operations.",
    "TanStack React Query is the server-state layer; queries/mutations are enabled only when identity exists and the actor is ready, with invalidation and optimistic updates for folders and file moves/deletes.",
    "Uploads use blob-storage’s ExternalBlob with per-file progress callbacks; UploadContext tracks upload batches and UnifiedProgressBar renders aggregate progress globally.",
    "File open behavior is MIME-aware (in-app viewer for images/videos/PDF; Office preview via Office Online embed; direct download for unsupported); external open attempts handle popup blocking via a retry/download fallback dialog.",
    "Backend is composed using Motoko mixins (authorization + blob-storage ops). Authorization bootstraps roles using an environment variable admin token plus a user-provided secret.",
    "PWA support is implemented with manifest.json and a service worker using minimal precaching and network-first runtime caching for fast startup.",
    "Repository includes baseline/freeze documentation for “Live v114” parity and change control (RESTORE_LIVE_V114_CHECKLIST.md, DRAFT_BASELINE_V114.md, V114_BASELINE_FRONTEND_FILES.txt, PAUSE_AFTER_RESTORE.md).",
    "Adjust startup flow so authentication/actor initialization happens in the background with silent retries on cold start; avoid blocking the UI with an 'initializing/service unavailable' screen unless failures persist beyond a threshold."
  ],
  "known_issues": [
    "frontend/src/components/NotesDialog.tsx and frontend/src/components/ProfileSetupDialog.tsx are empty placeholders, indicating incomplete/abandoned components.",
    "Two actor initialization mechanisms exist (ActorContext and the React Query-based useActor hook). Keeping both increases divergence risk and inconsistent behavior if both are used.",
    "React Query cache keys for user-scoped data (files/folders/notes/missions) are not explicitly namespaced by principal; correctness relies on clearing cache on sign-out and refetching on identity changes.",
    "Sign-out paths differ: Header sign-out calls InternetIdentity.clear() and queryClient.clear(), while ActorContext.signOut() does not clear React Query cache; different paths can leave stale cached data in memory.",
    "Notes sorting uses Number(b.updatedAt - a.updatedAt); converting BigInt timestamps to Number can lose precision and cause incorrect ordering.",
    "Multiple UI locations convert bigint timestamps to Number for Date formatting; large values can exceed JS safe integer range and yield incorrect dates.",
    "File/folder listing uses a fixed window (offset 0, limit 1000) and staleTime=0; not scalable for very large libraries and may refetch frequently.",
    "Uploads read entire files into memory via File.arrayBuffer() before sending; large files may cause memory pressure (no streaming upload).",
    "SendToFolderDialog returns files to main collection by calling removeFromFolder sequentially per file; slow for large selections (no batch endpoint).",
    "Service worker navigation fallback uses caches.match('/index.html'), but '/index.html' is not in PRECACHE_ASSETS; first-time offline navigation may fail.",
    "Both frontend/index.css and frontend/src/index.css exist with different token sets; depending on build/imports, this can cause styling drift/confusion (main.tsx imports src/index.css).",
    "Backend state uses non-stable vars/maps; canister upgrades/redeployments can lose state without stable storage/migrations.",
    "Backend findFileByTextId performs a linear scan across all files; performance will degrade as file counts grow.",
    "Backend createFolder returns ?Text (string id) while frontend treats Folder.id as bigint; this API/type-shape mismatch complicates typing and can cause runtime issues depending on generated bindings.",
    "Environment variable CAFFFEINE_STORAGE_CASHIER_PRINCIPAL appears misspelled (triple 'F'); increases deployment/configuration error risk.",
    "ActorInitErrorState imports isCanisterStoppedError but uses summary-string heuristics instead; may misclassify stopped-canister errors if wording changes.",
    "FileUploadSection UI copy mentions “drag and drop” but the component does not implement onDrop handlers (click-to-upload only).",
    "Cold start after deploy/prompt often shows 'Service Unavailable / backend unavailable (canister needs restart)' during actor initialization; user wants silent retry and normal app opening instead of frequent error UI on first open."
  ],
  "isFixRequest": true,
  "gameProjectType": "none",
  "projectName": "MyGallery",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}