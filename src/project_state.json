{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 3,
  "summary": "MyGallery is an installable Progressive Web App (React + TypeScript + Tailwind + shadcn/ui) backed by a Motoko canister on the Internet Computer. Users authenticate via Internet Identity with long-lived delegations. After login, the app initializes an identity-bound backend actor with explicit lifecycle states and structured error classification (including stopped-canister detection and retry/backoff). The core product is a personal file library: multi-file upload with progress, browsing a main “Collection” and folder views, in-app preview for images/videos/PDFs/Office docs, and file actions including move-to-folder, download, share (Web Share API), and single/bulk delete. It also includes per-user Notes and Missions (task checklists with progress) stored in the canister, plus backend access control (admin/user/guest) and operational endpoints (health/diagnostics and blob-storage maintenance/cycles refill).",
  "existing_features": [
    {
      "id": "IF-1",
      "title": "Installable PWA configuration (manifest + icons + meta)",
      "synonyms": [
        "PWA installability",
        "manifest.json",
        "favicons",
        "apple-touch-icon"
      ],
      "description": "Provides PWA install metadata (name, colors, start_url, display=standalone) and comprehensive favicon/iOS icon + meta configuration for MyGallery branding.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-2",
      "title": "Service worker with minimal precache and network-first runtime caching",
      "synonyms": [
        "sw.js",
        "runtime cache",
        "offline fallback"
      ],
      "description": "Implements a lightweight service worker with fast activation (skipWaiting/clients.claim), minimal precache, cache cleanup, and a network-first strategy with cache fallback for navigations and GET assets (excluding canister/API paths).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-3",
      "title": "Theme system (light/dark/system) with toggle",
      "synonyms": [
        "next-themes",
        "ThemeProvider",
        "theme toggle"
      ],
      "description": "App-wide theming using next-themes with a header toggle to switch between light and dark modes (system default supported).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-4",
      "title": "OKLCH-based design tokens for Tailwind (including Notes/Missions palettes)",
      "synonyms": [
        "CSS variables",
        "OKLCH tokens",
        "Tailwind color mapping"
      ],
      "description": "Defines extensive OKLCH CSS variables for light/dark themes and maps them into Tailwind colors, including dedicated accent/background palettes for Notes and Missions UI.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-5",
      "title": "Internet Identity authentication with persisted delegations",
      "synonyms": [
        "AuthClient",
        "DelegationIdentity",
        "30-day session"
      ],
      "description": "Supports Internet Identity login/logout and restores stored identities on reload; login requests ~30-day delegations and exposes detailed login status flags for UI gating.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-6",
      "title": "Unauthenticated welcome screen with login CTA",
      "synonyms": [
        "WelcomeIntroScreen",
        "login landing"
      ],
      "description": "Shows a dedicated welcome/marketing screen for unauthenticated users with English copy and a login button wired to Internet Identity.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-7",
      "title": "Post-login intro screen shown once per in-memory session",
      "synonyms": [
        "IntroScreen",
        "one-time session intro"
      ],
      "description": "Displays a timed animated intro only after a fresh successful login event and only once per session; restored delegations skip the intro.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-8",
      "title": "Secure admin token handling via URL hash + sessionStorage with normalization",
      "synonyms": [
        "caffeineAdminToken",
        "getSecretFromHash",
        "hash cleanup",
        "normalizeAdminToken"
      ],
      "description": "Extracts sensitive admin tokens from the URL hash, persists them in sessionStorage, removes them from the visible URL, and treats whitespace-only tokens as absent.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-9",
      "title": "ActorContext lifecycle management with guarded bootstrap and retry/backoff",
      "synonyms": [
        "ActorProvider",
        "idle/initializing/ready/unavailable/error",
        "exponential backoff"
      ],
      "description": "Creates an identity-bound canister actor after authentication, optionally bootstraps access control only when a normalized admin token is present, retries stopped-canister failures with exponential backoff under a budget, and exposes retry/sign-out actions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-10",
      "title": "Standardized actor initialization error classification and messaging",
      "synonyms": [
        "mapActorInitError",
        "IC0508 detection",
        "reject_code 5"
      ],
      "description": "Centralizes detection/mapping for stopped-canister, invalid admin token, actor-not-ready, and initialization failures into English summaries plus serialized technical details for UI display.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-11",
      "title": "Final-failure actor error screen with retry/logout and expandable diagnostics",
      "synonyms": [
        "ActorInitErrorState",
        "technical details",
        "stopped-canister UI"
      ],
      "description": "Shows a dedicated error state only after retry budget exhaustion (or fatal errors), with contextual messaging, expandable technical details, and actions to retry or sign out.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-12",
      "title": "Unified sign-out clears identity, actor state, and React Query cache",
      "synonyms": [
        "ActorContext.signOut",
        "queryClient.clear"
      ],
      "description": "Implements a single sign-out path that cancels retries, logs out from Internet Identity, clears React Query cache, and resets actor lifecycle state.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-13",
      "title": "React Query data layer for file and folder operations gated by auth + actor readiness",
      "synonyms": [
        "@tanstack/react-query",
        "enabled gating"
      ],
      "description": "Provides queries/mutations for files and folders that run only when an authenticated identity exists and ActorContext reports status=ready, using invalidation and optimistic update patterns.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-14",
      "title": "Upload UI with readiness gating and toast feedback",
      "synonyms": [
        "FileUploadSection",
        "sonner toasts",
        "dropzone"
      ],
      "description": "Multi-file upload input/dropzone that disables until the actor is ready, integrates with UploadContext, and shows success/failure toasts.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-15",
      "title": "Multi-file upload with chunked concurrency and per-file progress callbacks",
      "synonyms": [
        "useUploadFiles",
        "ExternalBlob.withUploadProgress"
      ],
      "description": "Uploads multiple files in small concurrent chunks, converts File objects to bytes, sends them to the canister, and emits per-file progress callbacks when provided.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-16",
      "title": "Global upload tracking with aggregated progress bar",
      "synonyms": [
        "UploadContext",
        "UnifiedProgressBar"
      ],
      "description": "Tracks upload batches and per-file progress globally, computes aggregate percent progress, and displays a compact progress bar under the header while uploads are active.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-17",
      "title": "Main collection and folder-scoped file listing",
      "synonyms": [
        "Collection view",
        "getPaginatedFiles",
        "getFilesInFolder"
      ],
      "description": "Lists files not assigned to any folder as the main Collection and lists files within a selected folder, using backend pagination parameters.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-18",
      "title": "Gallery grid UI with loading/empty/error states and MIME-aware tiles",
      "synonyms": [
        "GallerySection",
        "Skeleton loading",
        "MIME icons"
      ],
      "description": "Renders a file grid with skeleton loading, empty and error states; uses image thumbnails, video previews, and MIME-based icons for other file types.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-19",
      "title": "Touch long-press multi-select mode with bulk actions",
      "synonyms": [
        "selectionMode",
        "bulk toolbar",
        "vibration feedback"
      ],
      "description": "Supports touch long-press to enter selection mode, visually marks selections, and enables bulk move-to-folder, share, download, and delete actions via a fixed bottom action bar.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-20",
      "title": "Full-screen in-app viewer with swipe/keyboard navigation and action bar",
      "synonyms": [
        "FullScreenViewer",
        "swipe navigation",
        "keyboard navigation"
      ],
      "description": "Provides a full-screen viewer for supported formats with touch swipe + keyboard navigation and actions for move, share, download, delete, and Office ‘New Tab’ opening.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-21",
      "title": "File preview modal with embedded preview, metadata, and actions",
      "synonyms": [
        "FilePreviewDialog",
        "preview modal"
      ],
      "description": "Shows a per-file dialog preview (image/video/PDF/Office via iframe), displays MIME type/created date/size, and provides open/download/move/delete actions with confirmation.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-22",
      "title": "Unified file open rules (viewer vs office preview vs download-only)",
      "synonyms": [
        "fileOpenRules",
        "filePreview categorization"
      ],
      "description": "Determines the primary click/tap behavior based on MIME type: in-app viewer for images/videos/PDFs, Office preview with optional new-tab open, and download-only for unsupported types.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-23",
      "title": "External open + download utilities with popup-blocker fallback dialog",
      "synonyms": [
        "openExternally",
        "downloadFile",
        "ExternalOpenFallbackDialog"
      ],
      "description": "Attempts to open files in a new tab/window with popup-blocker detection; when blocked, shows a dialog offering retry or a reliable fetch+blob download fallback.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-24",
      "title": "Web Share API integration for sharing files",
      "synonyms": [
        "navigator.share",
        "share files"
      ],
      "description": "Shares single or multiple selected files by fetching direct URLs, creating File objects, and invoking the Web Share API when available.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-25",
      "title": "Folder management UI (list/create/rename/delete/select) with optimistic updates",
      "synonyms": [
        "FoldersDialog",
        "optimistic UI"
      ],
      "description": "Implements folder listing, creation, renaming, deletion, and selection via React Query mutations, including optimistic cache updates with rollback for rename/delete.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-26",
      "title": "Move files into folders and return files to main collection",
      "synonyms": [
        "moveFilesToFolder",
        "removeFromFolder",
        "SendToFolderDialog"
      ],
      "description": "Moves one or many files into a selected folder and supports returning files back to the main collection by removing folder assignment.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-27",
      "title": "Single and bulk file deletion with chunking and optimistic cache updates",
      "synonyms": [
        "deleteFile",
        "deleteFiles",
        "CHUNK_SIZE=50"
      ],
      "description": "Deletes individual files and bulk deletes in backend-sized chunks, applying optimistic cache updates across main and folder queries with rollback on error.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-28",
      "title": "Notes: per-user multi-note CRUD with responsive full-screen UI",
      "synonyms": [
        "NotesFullScreenView",
        "create/update/delete notes",
        "mobile editor"
      ],
      "description": "Implements per-user notes stored in the canister with list/detail/create/update/delete hooks and a full-screen UI optimized for mobile (list/editor toggling) and desktop (split view).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-29",
      "title": "Missions: per-user missions with tasks, progress, and CRUD UI",
      "synonyms": [
        "MissionsFullScreenView",
        "MissionEditorDialog",
        "MissionDetailFullScreenView"
      ],
      "description": "Implements per-user missions stored in the canister with task checklists and progress display; supports create (modal), list with progress bars, detail view editing, save, and delete with confirmation and optimistic cache updates.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-30",
      "title": "Backend role-based access control with optional admin bootstrap",
      "synonyms": [
        "AccessControl",
        "MixinAuthorization",
        "CAFFEINE_ADMIN_TOKEN"
      ],
      "description": "Implements role tracking (admin/user/guest), admin bootstrap via an environment token plus user-provided secret, role queries, and admin-only role assignment; backend methods enforce permissions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-31",
      "title": "Backend file storage with ownership enforcement and folder organization",
      "synonyms": [
        "uploadFile",
        "getPaginatedFiles",
        "getFilesInFolder",
        "moveFilesToFolder",
        "deleteFiles"
      ],
      "description": "Stores file blobs and metadata, enforces per-owner access (admin override), supports listing (unfoldered and folder-scoped), moving to/from folders, and deletion (single/bulk).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-32",
      "title": "Backend folder storage (per-user) with cascading deletion behavior",
      "synonyms": [
        "createFolder",
        "getAllFolders",
        "renameFolder",
        "deleteFolder"
      ],
      "description": "Implements per-user folder CRUD with ownership checks; deleting a folder removes the caller’s files assigned to that folder.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-33",
      "title": "Backend notes storage (per-user)",
      "synonyms": [
        "createNote",
        "updateNote",
        "listNotes",
        "deleteNote"
      ],
      "description": "Stores notes per principal with ownership enforced; supports create/get/update/delete/list operations.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-34",
      "title": "Backend missions storage (per-user)",
      "synonyms": [
        "createMission",
        "updateMission",
        "listMissions",
        "deleteMission"
      ],
      "description": "Stores missions per principal with tasks; supports create/get/update/delete/list operations and enforces ownership/permissions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-35",
      "title": "Backend user profile endpoints with access control",
      "synonyms": [
        "getCallerUserProfile",
        "saveCallerUserProfile",
        "getUserProfile"
      ],
      "description": "Stores and retrieves a simple per-user profile record with access controls (users can access their own; admins can access others).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-36",
      "title": "Backend health and diagnostics endpoints",
      "synonyms": [
        "getHealth",
        "getDiagnostics",
        "cycles balance"
      ],
      "description": "Exposes query endpoints returning build/version information and current cycles balance for operational visibility.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-37",
      "title": "Blob-storage maintenance and cycles refill endpoints (backend)",
      "synonyms": [
        "_caffeineStorageUpdateGatewayPrincipals",
        "_caffeineStorageBlobsToDelete",
        "_caffeineStorageConfirmBlobDeletion",
        "_caffeineStorageRefillCashier"
      ],
      "description": "Provides maintenance endpoints for updating authorized gateway principals, listing/confirming dead blob deletions (including GC trigger), and cashier-driven cycles top-ups.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-38",
      "title": "Baseline parity and change-control documentation (Live v114)",
      "synonyms": [
        "DRAFT_BASELINE_V114",
        "RESTORE_LIVE_V114_CHECKLIST",
        "V114_BASELINE_FRONTEND_FILES"
      ],
      "description": "Includes documentation and canonical file lists to validate and preserve 1:1 parity with Live version 114 and enforce post-restore change-control policies.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "feature-implement-swipe-left-right-to-left-gesture-on-touch-mobile-for-each-folder-item-in-the-folders-ui-list-to-reveal-ios-style-actions-a-red-delete-button-and-an-edit-button-next-to-it-the-actions-must-remain-visible-after-the-swipe-until-the-user-closes-them-e-g-by-swiping-back-tapping-outside-or-opening-another-item-on-non-touch-desktop-the-swipe-interaction-must-be-disabled-and-the-existing-click-hover-controls-must-remain-usable",
      "title": "Implement swipe-left (right-to-left) gesture on touch/mobile for each Folder item in the Folders UI list to reveal iOS-style actions: a red 'Delete' button and an 'Edit' button next to it. The actions must remain visible after the swipe until the user closes them (e.g., by swiping back, tapping outside, or opening another item). On non-touch/desktop, the swipe interaction must be disabled and the existing click/hover controls must remain usable.",
      "reqIds": [
        "REQ-1"
      ],
      "version": 1
    },
    {
      "id": "feature-implement-swipe-left-gesture-on-touch-mobile-for-each-note-item-in-the-notes-list-to-reveal-ios-style-actions-a-red-delete-button-and-an-edit-button-for-editing-the-note-title-the-swipe-interaction-must-be-touch-only-on-desktop-existing-interactions-remain-unchanged-the-revealed-actions-must-remain-visible-after-the-swipe-until-dismissed",
      "title": "Implement swipe-left gesture on touch/mobile for each Note item in the Notes list to reveal iOS-style actions: a red 'Delete' button and an 'Edit' button for editing the note title. The swipe interaction must be touch-only; on desktop, existing interactions remain unchanged. The revealed actions must remain visible after the swipe until dismissed.",
      "reqIds": [
        "REQ-2"
      ],
      "version": 1
    },
    {
      "id": "feature-implement-swipe-left-gesture-on-touch-mobile-for-each-mission-item-in-the-missions-list-to-reveal-ios-style-actions-a-red-delete-button-and-an-edit-button-for-editing-the-mission-title-the-swipe-interaction-must-be-touch-only-on-desktop-existing-interactions-remain-unchanged-the-revealed-actions-must-remain-visible-after-the-swipe-until-dismissed",
      "title": "Implement swipe-left gesture on touch/mobile for each Mission item in the Missions list to reveal iOS-style actions: a red 'Delete' button and an 'Edit' button for editing the mission title. The swipe interaction must be touch-only; on desktop, existing interactions remain unchanged. The revealed actions must remain visible after the swipe until dismissed.",
      "reqIds": [
        "REQ-3"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [
    {
      "id": "AR-1",
      "summary": "Add iOS-style swipe-left actions on mobile for user-created Folders/Notes/Missions list items to reveal Delete (red) and Edit/Rename buttons; only one item can be open at a time",
      "reqIds": [],
      "status": "pending"
    }
  ],
  "architectural_notes": [
    "Frontend is a React SPA using function components, TypeScript, TailwindCSS (CSS variables in OKLCH), and shadcn/ui component primitives.",
    "Authentication uses Internet Identity via @dfinity/auth-client; stored delegations are restored on load and new logins request ~30-day maxTimeToLive delegations.",
    "Backend access is via an identity-bound canister actor created in ActorContext; actor lifecycle is tracked (idle/initializing/ready/unavailable/error) with guarded initialization.",
    "Actor initialization errors are centrally classified (stopped canister / invalid admin token / not-ready / init-failed), and stopped-canister errors are retried with exponential backoff up to a budget.",
    "TanStack React Query is the server-state layer; queries/mutations are gated on (identity present && actor status === ready) and use invalidation plus optimistic update/rollback where appropriate.",
    "Uploads are coordinated via an UploadContext that aggregates per-file progress into a unified progress bar; the upload mutation uses ExternalBlob progress callbacks.",
    "File UX is MIME-aware: thumbnails for images, previews for video/PDF/Office (Office Online embed), and download-only for unsupported types; external open attempts handle popup-blocker fallback via a dialog.",
    "Backend is a Motoko actor composed with mixins (authorization/access-control and blob-storage maintenance), enforcing per-user ownership and role-based permissions."
  ],
  "known_issues": [
    "Some component files are empty placeholders (e.g., frontend/src/components/NotesDialog.tsx, ConnectivityIndicator.tsx, ProfileSetupDialog.tsx), which can confuse maintainers and baseline validation.",
    "Legacy frontend/src/hooks/useActor.ts unconditionally calls _initializeAccessControlWithSecret with possibly empty token; ActorContext uses guarded/normalized token handling—these parallel implementations can diverge.",
    "Notes sorting uses Number(b.updatedAt - a.updatedAt) on bigint timestamps, risking precision loss and unstable ordering for large values.",
    "File and folder listing uses fixed pagination windows (offset 0, limit 1000) and staleTime=0, which may not scale for large libraries and can cause frequent refetching.",
    "Uploads read entire files into memory via File.arrayBuffer(); large uploads may cause memory pressure (no streaming).",
    "Backend state is stored in non-stable variables/Maps; canister upgrades risk data loss without stable memory migration logic.",
    "Environment variable CAFFFEINE_STORAGE_CASHIER_PRINCIPAL appears misspelled (extra 'F'), increasing deployment/configuration risk.",
    "Backend createFolder returns ?Text (string id) while folder IDs are Nat in the data model, creating an API/typing inconsistency.",
    "Service worker precaches only /manifest.json but navigation fallback may attempt caches.match('/index.html'); first-time offline navigation can fail unless index.html is cached at runtime.",
    "Returning files to the main collection in SendToFolderDialog removes folder assignment sequentially per file (potentially slow for large selections)."
  ],
  "isFixRequest": false,
  "gameProjectType": "none",
  "projectName": "MyGallery",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}